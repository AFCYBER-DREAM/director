---
- import_tasks: osp-repos.yml

- name: Install all the required rpms (this will take a while)
  yum:
    name: "{{ req_rpm }}"
    state: latest

- name: Create the group stack
  group:
    name: "{{ stack_group }}"
    state: present

- name: Create the user stack 
  user:
    name: "{{ stack_user }}"
    group: "{{ stack_group }}"
    password: "{{ stack_passwd }}" #can use vault

- name: Create the required directories
  file:
    state: directory
    name: "{{ item }}"
    group: "{{ stack_group }}"
  with_items:
    - /home/stack/images/
    - /home/stack/templates/

- name: Create the stack file for sudoers
  copy:
    src: stack
    dest: /etc/sudoers.d/
    mode: "{{ sudoer_perm }}"

- name: Copy over the undercloud file
  template:
    src: undercloud.conf.j2
    dest: /home/stack/undercloud.conf
    mode: "{{ sudoer_perm }}"
    group: "{{ stack_group }}"
    owner: "{{ stack_user }}"

- name: Install the undercloud
  become: yes
  become_user: stack
  shell: openstack undercloud install
  args:
    chdir: /home/stack
  async: 2700
  poll: 30

- name: Check openstack catalog list
  shell: openstack catalog list >> catalog.txt

- name: Verify neutron
  shell: neutron net-list

- name: Verify neutron 2
  shell: neutron subnet-list


